<odoo>
    <data>

        <!-- ============================= -->
        <!-- 1) TIPO DE ESTRUCTURA MEGA   -->
        <!-- ============================= -->
        <record id="mega_structure_type_employee" model="hr.payroll.structure.type">
            <field name="name">MEGA - Empleado - Quincenal</field>
            <field name="default_schedule_pay">semi-monthly</field>
            <field name="country_id" ref="base.co"/>
        </record>

        <!-- ============================= -->
        <!-- 2) ESTRUCTURA DE NÓMINA      -->
        <!-- ============================= -->
        <record id="mega15_structure" model="hr.payroll.structure">
            <field name="name">MEGA15 PAGO REGULAR - Quincenal</field>
            <field name="code">MEGA15</field>
            <field name="type_id" ref="mega_structure_type_employee"/>
        </record>

        <!-- ============================= -->
        <!-- 3) Descuento por días no trabajado    -->
        <!-- ============================= -->
        <!-- ============================= -->
        <record id="mega_rule_descuento_falta" model="hr.salary.rule">
            <field name="name">Descuento por días no trabajados</field>
            <field name="code">DESC_FALTA</field>
            <field name="sequence">25</field>
            <field name="category_id" ref="hr_payroll.DED"/>
            <field name="struct_id" ref="mega15_structure"/>

            <!-- Solo aplica si existe LEAVE90 (Sin pagar) -->
            <field name="condition_select">python</field>
            <field name="condition_python"><![CDATA[
unpaid_days = 0.0
for wd in worked_days.values():
    if wd.code == 'LEAVE90':
        unpaid_days += wd.number_of_days
result = unpaid_days > 0
            ]]></field>

            <field name="amount_select">code</field>
            <field name="amount_python_compute"><![CDATA[
# Salario quincenal del contrato
wage = contract.wage or 0.0

# Días sin pagar (código LEAVE90)
unpaid_days = 0.0
for wd in worked_days.values():
    if wd.code == 'LEAVE90':
        unpaid_days += wd.number_of_days

# Valor diario (quincena = 15 días)
daily_wage = wage / 15.0 if wage else 0.0

# Mostrar los días en la columna "Cantidad"
result_qty = unpaid_days

# Valor por día (negativo)
result = -daily_wage

# Tasa 100% (para que no afecte)
result_rate = 100.0
            ]]></field>
        </record>


        <!-- ============================= -->
        <!-- 4) AUXILIO DE TRANSPORTE     -->
        <!-- ============================= -->
        <!-- ============================= -->
        <record id="mega_rule_aux_trans" model="hr.salary.rule">
            <field name="name">Auxilio de transporte</field>
            <field name="code">AUX_TRANS</field>
            <field name="sequence">30</field>
            <field name="category_id" ref="hr_payroll.ALW"/>
            <field name="struct_id" ref="mega15_structure"/>

            <!-- Condición: sueldo <= 2 SMMLV -->
            <field name="condition_select">python</field>
            <field name="condition_python"><![CDATA[
smmlv = payslip.company_id.smmlv_value or 0.0
wage = contract.wage or 0.0
result = (wage * 2) <= 2.0 * smmlv
            ]]></field>

            <field name="amount_select">code</field>
            <field name="amount_python_compute"><![CDATA[
# Auxilio mensual configurado en la compañía
stm_month = payslip.company_id.stm_value or 0.0

# Quincena (mitad del mes)
aux_quincena = stm_month / 2.0

# Días del periodo de nómina
period_days = (payslip.date_to - payslip.date_from).days + 1

# Días sin pagar (código LEAVE90 = "Sin pagar")
unpaid_days = 0.0
for wd in worked_days.values():
    if wd.code in ('LEAVE90',):  # agrega otros códigos si quieres excluir más
        unpaid_days += wd.number_of_days

paid_days = period_days - unpaid_days

if period_days > 0:
    # Proporcional al tiempo realmente trabajado
    result = aux_quincena * (paid_days / period_days)
else:
    result = 0.0
            ]]></field>
        </record>


        <!-- ============================= -->
        <!-- COMISIONES / OTROS DEVENGADOS -->
        <!-- ============================= -->
        <record id="mega_rule_comisiones" model="hr.salary.rule">
            <field name="name">Comisiones / Otros devengados</field>
            <field name="code">COMISIONES</field>
            <field name="sequence">35</field>
            <!-- Devengado -->
            <field name="category_id" ref="hr_payroll.ALW"/>
            <field name="struct_id" ref="mega15_structure"/>

            <!-- Solo aplica si hay algún input del tipo elegido -->
            <field name="condition_select">python</field>
            <field name="condition_python"><![CDATA[
result = inputs.get('OTDEV')
            ]]></field>

            <field name="amount_select">code</field>
            <field name="amount_python_compute"><![CDATA[
input_otdev = inputs.get('OTDEV')
amount = input_otdev.amount if input_otdev else 0.0
result = amount
            ]]></field>
        </record>



        <!-- ============================= -->
        <!-- 5) SALUD 4%                   -->
        <!-- ============================= -->
        <record id="mega_rule_salud4" model="hr.salary.rule">
            <field name="name">Salud (Trabajador)</field>
            <field name="code">SALUD4</field>
            <field name="sequence">40</field>
            <field name="category_id" ref="hr_payroll.DED"/>
            <field name="struct_id" ref="mega15_structure"/>

            <field name="condition_select">none</field>
            <field name="amount_select">code</field>

            <field name="amount_python_compute"><![CDATA[
# Base cotizable: categoría BASIC (incluye SAL_PRO)
base = categories.get('BASIC', 0.0)

rate = (payslip.company_id.salud_employee_rate or 0.0) / 100.0

# Retención del 4%
result = -(base * rate)
result_name = f"Salud (Trabajador {rate * 100}%)"
            ]]></field>
        </record>


        <!-- ============================= -->
        <!-- 6) PENSIÓN 4%                 -->
        <!-- ============================= -->
        <record id="mega_rule_pension4" model="hr.salary.rule">
            <field name="name">Pensión (Trabajador)</field>
            <field name="code">PENSION4</field>
            <field name="sequence">50</field>
            <field name="category_id" ref="hr_payroll.DED"/>
            <field name="struct_id" ref="mega15_structure"/>

            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute"><![CDATA[
# Base cotizable: categoría BASIC (incluye SAL_PRO)
base = categories.get('BASIC', 0.0)

rate = (payslip.company_id.pension_employee_rate or 0.0) / 100.0

# Retención 4% pensión
result = -(base * rate)
result_name = f"Pensión (Trabajador {rate * 100}%)"
            ]]></field>
        </record>


        <!-- ===================== -->
        <!-- CATEGORÍAS ADICIONALES -->
        <!-- ===================== -->

        <record id="mega_cat_aportes_empleador" model="hr.salary.rule.category">
            <field name="name">Aportes empleador</field>
            <field name="code">EMP_APORTES</field>
        </record>


        <!-- ===================== -->
        <!-- REGLA: SALUD EMPLEADOR -->
        <!-- ===================== -->

        <record id="mega_rule_salud_empleador" model="hr.salary.rule">
            <field name="name">Salud (Empleador)</field>
            <field name="code">SALUD_EMP</field>
            <field name="sequence">45</field>

            <field name="category_id" ref="mega_cat_aportes_empleador"/>
            <field name="struct_id" ref="mega15_structure"/>
            <field name="appears_on_payslip">True</field>

            <field name="condition_select">python</field>
            <field name="condition_python"><![CDATA[
# aplica solo si hay salario básico / imponible
result = contract.wage is not None and contract.wage > 0.0
    ]]></field>

            <field name="amount_select">code</field>
            <field name="amount_python_compute"><![CDATA[
# Base de cotización: salario del contrato
base = contract.wage or 0.0

rate = (payslip.company_id.salud_employer_rate or 0.0) / 100.0

# Ejemplo: 8.5% salud empleador
result = base * rate
result_name = f"Salud (Empleador {rate * 100}%)"
    ]]></field>
        </record>


        <!-- ===================== -->
        <!-- REGLA: PENSIÓN EMPLEADOR -->
        <!-- ===================== -->

        <record id="mega_rule_pension_empleador" model="hr.salary.rule">
            <field name="name">Pensión (Empleador)</field>
            <field name="code">PENSION_EMP</field>
            <field name="sequence">55</field>

            <field name="category_id" ref="mega_cat_aportes_empleador"/>
            <field name="struct_id" ref="mega15_structure"/>
            <field name="appears_on_payslip">True</field>

            <field name="condition_select">python</field>
            <field name="condition_python"><![CDATA[
# aplica solo si hay salario básico / imponible
result = contract.wage is not None and contract.wage > 0.0
    ]]></field>

            <field name="amount_select">code</field>
            <field name="amount_python_compute"><![CDATA[
# Base de cotización: salario del contrato
base = contract.wage or 0.0

rate = (payslip.company_id.pension_employer_rate or 0.0) / 100.0

# Ejemplo: 8.5% salud empleador
result = base * rate
result_name = f"Pensión (Empleador {rate * 100}%)"
    ]]></field>
        </record>


    </data>
</odoo>
